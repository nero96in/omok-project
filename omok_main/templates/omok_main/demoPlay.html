{% load static %}
<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Board</title>
  <style>
  body { text-align: center; }
  div { margin: 20px auto; color: #888; }
  </style>
</head>
<body>

<div id="board"></div>

<script type="text/javascript" src="{% static 'omok_main/dist/jgoboard-latest.js' %}"></script>
<script type="text/javascript" src="{% static 'omok_main/large/board.js' %}"></script>
<script type="text/javascript">
var roomName = {{ room_name_json }};
var userName = {{ user_name_json }};

var updateCaptures = function (node) {
  document.getElementById('black-captures').innerText = node.info.captures[JGO.BLACK];
  document.getElementById('white-captures').innerText = node.info.captures[JGO.WHITE];
};
var jrecord = new JGO.Record(19);
var jboard = jrecord.jboard;
var jsetup = new JGO.Setup(jboard, JGO.BOARD.largeWalnut);
var player = undefined; // next player

var current_player = undefined
var black_player = undefined
var white_player = undefined

var ko = false, lastMove = false; // ko coordinate and last move coordinate
var lastHover = false, lastX = -1, lastY = -1; // hover helper vars
jsetup.setOptions({stars: {points:5}});
jsetup.create('board', function(canvas) {
  var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/omok/' + roomName + '/');

  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };

  canvas.addListener('click', function(coord, ev) {
    // console.log(player, coord)
    message = {"player": player, "x": coord['i'], "y": coord['j']}
    console.log(message)
    // var opponent = (player == JGO.BLACK) ? JGO.WHITE : JGO.BLACK;

    if(lastHover)
      jboard.setType(new JGO.Coordinate(lastX, lastY), JGO.CLEAR);

    lastHover = false;

    var play = jboard.playMove(coord, player, ko);
    console.log(play)

    if(play.success) {
      chatSocket.send(JSON.stringify({
          'message': message
      }));
      // player = opponent;
    } else {
      // alert('Illegal move: ' + play.errorMsg);
    }
  });

  chatSocket.onmessage = function(e) {
    var data = JSON.parse(e.data);
    var message = data['message'];
    var start_settings = data['start_settings']
    console.log(data)
    
    if(message){
      console.log(message)
      // player = message['player']
      x = message['x']
      y = message['y']
      coord = new JGO.Coordinate(x, y)
      if(message['current_player'] == 1){
        current_player = 2
      } else{
        current_player = 1
      }

      node = jrecord.createNode(true);
      node.setType(coord, message['player']); // play stone
      if(lastMove)
        node.setMark(lastMove, JGO.MARK.NONE); // clear previous mark
      node.setMark(coord, JGO.MARK.CIRCLE); // mark move
      lastMove = coord;

      if(message['alert']){
        alert(message['alert'])
      }
    }

    if(start_settings) {
      black_player = start_settings['black']
      white_player = start_settings['white']
      current_player = start_settings['current_player']

      console.log('black:', black_player)
      console.log('white:', white_player)

      if(userName == black_player){
        player = 1
      } else if(userName == white_player){
        player = 2
      }
      alert(start_settings['alert'])
    }
  };

  canvas.addListener('mousemove', function(coord, ev) {
    if(coord.i == -1 || coord.j == -1 || (coord.i == lastX && coord.j == lastY))
      return;

    if(lastHover) // clear previous hover if there was one
      jboard.setType(new JGO.Coordinate(lastX, lastY), JGO.CLEAR);

    lastX = coord.i;
    lastY = coord.j;
    //console.log(lastX, lastY)

    console.log(current_player, player)
    if(current_player == player){
      if(jboard.getType(coord) == JGO.CLEAR && jboard.getMark(coord) == JGO.MARK.NONE) {
        if(player == 1){
          jboard.setType(coord, JGO.DIM_BLACK);
        } else if(player == 2){
          jboard.setType(coord, JGO.DIM_WHITE);
        }

        //jboard.setType(coord, player == JGO.WHITE ? JGO.DIM_WHITE : JGO.DIM_BLACK);
        lastHover = true;
      } else
        lastHover = false;
    }
    
  });

  canvas.addListener('mouseout', function(ev) {
    if(lastHover)
      jboard.setType(new JGO.Coordinate(lastX, lastY), JGO.CLEAR);

    lastHover = false;
  });
});
</script>

</body>
</html>
